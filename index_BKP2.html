<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPLE√ÉO - Gest√£o de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // NAVEGA√á√ÉO
        // ==========================================
        function mostrarAba(abaId) {
            const abas = ['aba-cadastro', 'aba-clientes', 'aba-produtos', 'aba-logistica'];
            abas.forEach(aba => document.getElementById(aba).classList.add('hidden'));
            document.getElementById(abaId).classList.remove('hidden');
            
            const botoes = ['btn-cadastro', 'btn-clientes', 'btn-produtos', 'btn-logistica'];
            botoes.forEach(btn => document.getElementById(btn).classList.remove('bg-gray-700'));
            document.getElementById('btn-' + abaId.split('-')[1]).classList.add('bg-gray-700');
        }

        // ==========================================
        // FUN√á√ïES DA TABELA DO PEDIDO E C√ÅLCULOS
        // ==========================================
        function adicionarLinha() {
            const tbody = document.getElementById('tabela-itens');
            const novaLinha = document.createElement('tr');
            novaLinha.className = 'text-sm';
            novaLinha.innerHTML = `
                <td class="p-2 border"><input type="number" value="1" min="1" class="w-16 p-1 border rounded qtd-item" onchange="calcularTudo()" onkeyup="calcularTudo()"></td>
                <td class="p-2 border">
                    <input type="text" list="lista-sugestao-produtos" placeholder="Nome do produto" class="w-full p-1 border rounded desc-item border-blue-300 focus:ring-2 focus:ring-blue-500" onchange="window.preencherProduto(this)">
                </td>
                <td class="p-2 border">
                    <input type="text" placeholder="Fornecedor" class="w-full p-1 border rounded forn-item">
                </td>
                <td class="p-2 border"><input type="number" value="0.00" step="0.01" class="w-24 p-1 border rounded valor-item" onchange="calcularTudo()" onkeyup="calcularTudo()"></td>
                <td class="p-2 border font-semibold total-linha">R$ 0,00</td>
                <td class="p-2 border text-center"><button onclick="this.closest('tr').remove(); calcularTudo();" class="text-red-500 font-bold hover:text-red-700">X</button></td>
            `;
            tbody.insertBefore(novaLinha, document.getElementById('linha-adicionar'));
        }

        function calcularTudo() {
            const linhas = document.querySelectorAll('#tabela-itens tr:not(#linha-adicionar)');
            let subtotal = 0;

            linhas.forEach(linha => {
                const qtd = parseFloat(linha.querySelector('.qtd-item')?.value) || 0;
                const valor = parseFloat(linha.querySelector('.valor-item')?.value) || 0;
                const totalLinha = qtd * valor;
                if(linha.querySelector('.total-linha')) linha.querySelector('.total-linha').innerText = 'R$ ' + totalLinha.toFixed(2).replace('.', ',');
                subtotal += totalLinha;
            });

            const pctDesconto = parseFloat(document.getElementById('input-desconto').value) || 0;
            const valorDesconto = subtotal * (pctDesconto / 100);
            const subtotalComDesconto = subtotal - valorDesconto;

            const km = parseFloat(document.getElementById('input-km').value) || 0;
            const frete = km > 0 ? (km / 9.0) * 4.20 : 0;
            document.getElementById('display-frete-estimado').value = 'R$ ' + frete.toFixed(2).replace('.', ',');

            const formaPgto = document.getElementById('select-pagamento').value;
            let taxaCartao = 0;
            if (formaPgto === 'Cart√£o de Cr√©dito') {
                taxaCartao = (subtotalComDesconto + frete) * 0.05; 
                document.getElementById('info-taxa').innerText = `Taxa Maquininha (5%): R$ ${taxaCartao.toFixed(2).replace('.', ',')}`;
                document.getElementById('info-taxa').classList.remove('hidden');
            } else {
                document.getElementById('info-taxa').classList.add('hidden');
            }

            const totalGeral = subtotalComDesconto + frete + taxaCartao;

            document.getElementById('display-subtotal').innerText = 'Subtotal: R$ ' + subtotal.toFixed(2).replace('.', ',');
            document.getElementById('display-desconto').innerText = 'Desconto: - R$ ' + valorDesconto.toFixed(2).replace('.', ',');
            document.getElementById('display-frete-final').innerText = 'Frete: R$ ' + frete.toFixed(2).replace('.', ',');
            
            const displayTaxa = document.getElementById('display-taxa-final');
            if (taxaCartao > 0) {
                displayTaxa.innerText = 'Acr√©scimo Cart√£o: R$ ' + taxaCartao.toFixed(2).replace('.', ',');
                displayTaxa.classList.remove('hidden');
            } else {
                displayTaxa.classList.add('hidden');
            }

            document.getElementById('display-total').innerText = 'Total: R$ ' + totalGeral.toFixed(2).replace('.', ',');
            document.getElementById('btn-gerar-pdf').setAttribute('data-total', totalGeral.toFixed(2).replace('.', ','));
        }

        // ==========================================
        // GERAR PDF
        // ==========================================

function gerarPDF() {
    const btn = document.getElementById('btn-gerar-pdf');
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '‚ú® Gerando PDF...';

    // 1. Coleta de dados
    const idAtual = document.getElementById('pedido-id-atual').value;
    const numeroPedido = document.getElementById('pdf-n-display').innerText || 'NOVO';
    const cliente = document.getElementById('input-cliente').value || 'N√£o informado';
    const endereco = document.getElementById('input-endereco').value || 'N√£o informado';
    const previsao = document.getElementById('input-previsao').value || 'A combinar';
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const totalGeral = btn.getAttribute('data-total') || '0,00';

    // 2. Montagem das linhas da tabela
    let linhasHtml = '';
    document.querySelectorAll('#tabela-itens tr:not(#linha-adicionar)').forEach(linha => {
        const qtd = linha.querySelector('.qtd-item')?.value || '0';
        const desc = linha.querySelector('.desc-item')?.value || '';
        const total = linha.querySelector('.total-linha')?.innerText || 'R$ 0,00';
        
        if(desc.trim() !== '') {
            linhasHtml += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px; text-align: center;">${qtd}</td>
                    <td style="padding: 10px;">${desc}</td>
                    <td style="padding: 10px; text-align: right; font-weight: bold;">${total}</td>
                </tr>`;
        }
    });

    // 3. Constru√ß√£o do HTML do Documento Inteiro
    const conteudoCompleto = `
        <div style="padding: 40px; font-family: Arial, sans-serif; color: #333; line-height: 1.5;">
            <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                <div>
                    <h1 style="margin: 0; font-size: 24px;">MPLE√ÉO</h1>
                    <p style="margin: 0; font-size: 12px; color: #666;">Serralheria & Vidra√ßaria</p>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin: 0; font-size: 18px;">PEDIDO ${numeroPedido}</h2>
                    <p style="margin: 0; font-size: 12px;">Data: ${dataAtual}</p>
                </div>
            </div>

            <div style="background: #f4f4f4; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 13px;">
                <p><strong>Cliente:</strong> ${cliente}</p>
                <p><strong>Endere√ßo:</strong> ${endereco}</p>
                <p><strong>Previs√£o de Entrega:</strong> ${previsao}</p>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px;">
                <thead>
                    <tr style="background: #333; color: #fff; text-align: left;">
                        <th style="padding: 10px; width: 50px; text-align: center;">Qtd</th>
                        <th style="padding: 10px;">Descri√ß√£o</th>
                        <th style="padding: 10px; width: 120px; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${linhasHtml}
                </tbody>
            </table>

            <div style="text-align: right; margin-bottom: 50px;">
                <div style="display: inline-block; background: #333; color: #fff; padding: 15px; border-radius: 5px;">
                    <span style="font-size: 10px; text-transform: uppercase; display: block;">Total a Pagar</span>
                    <strong style="font-size: 20px;">R$ ${totalGeral}</strong>
                </div>
            </div>

            <div style="margin-top: 100px; display: flex; justify-content: space-between;">
                <div style="width: 40%; border-top: 1px solid #333; text-align: center; padding-top: 5px; font-size: 11px;">Assinatura MPLE√ÉO</div>
                <div style="width: 40%; border-top: 1px solid #333; text-align: center; padding-top: 5px; font-size: 11px;">Assinatura do Cliente</div>
            </div>
        </div>
    `;

    // 4. Configura√ß√£o e Gera√ß√£o
    const opcoes = {
        margin: 0,
        filename: `Pedido_${cliente.replace(/\s+/g, '_')}.pdf`,
        image: { type: 'jpeg', quality: 1.0 },
        html2canvas: { scale: 2, logging: false },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // Gera a partir da string de HTML diretamente
    html2pdf().set(opcoes).from(conteudoCompleto).save().then(() => {
        btn.innerHTML = textoOriginal;
    }).catch(err => {
        console.error("Erro no PDF:", err);
        btn.innerHTML = 'Erro ao gerar';
    });
}

        window.limparTelaPedido = function() {
            document.getElementById('pedido-id-atual').value = '';
            document.getElementById('input-cliente').value = '';
            document.getElementById('input-endereco').value = '';
            document.getElementById('select-status').value = 'Or√ßamento';
            document.getElementById('pdf-n-display').innerText = '#000';
            document.getElementById('tabela-itens').innerHTML = '<tr class="text-sm" id="linha-adicionar"><td colspan="6" class="p-2 text-center"><button onclick="adicionarLinha()" class="text-blue-600 font-bold">+ Adicionar Novo Item</button></td></tr>';
            adicionarLinha();

            // Destrava campos para novo pedido
            document.querySelectorAll('#aba-cadastro input, #aba-cadastro select').forEach(el => el.disabled = false);
            document.getElementById('btn-salvar').classList.remove('hidden');
            const tit = document.getElementById('titulo-aba-pedido');
            tit.innerText = 'Novo Pedido';
            tit.classList.remove('text-red-600', 'text-orange-500');

            calcularTudo();
            mostrarAba('aba-cadastro');
        }
    </script>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row h-screen overflow-hidden">

    <datalist id="lista-sugestao-clientes"></datalist>
    <datalist id="lista-sugestao-produtos"></datalist>

    <aside class="w-full md:w-64 bg-gray-900 text-white flex flex-col flex-shrink-0">
        <div class="p-4 md:p-6 text-center border-b border-gray-700">
            <h1 class="text-xl md:text-2xl font-bold text-yellow-500">MPLE√ÉO</h1>
            <p class="text-xs text-gray-400">Sistema de Gest√£o</p>
        </div>
        <nav class="flex flex-row md:flex-col p-4 gap-2 overflow-x-auto whitespace-nowrap">
            <button id="btn-cadastro" onclick="mostrarAba('aba-cadastro')" class="text-sm md:text-base text-left p-3 bg-gray-700 rounded hover:bg-gray-600 transition">üì¶ Gest√£o de Pedido</button>
            <button id="btn-clientes" onclick="mostrarAba('aba-clientes')" class="text-sm md:text-base text-left p-3 rounded hover:bg-gray-600 transition">üë• Clientes</button>
            <button id="btn-produtos" onclick="mostrarAba('aba-produtos')" class="text-sm md:text-base text-left p-3 rounded hover:bg-gray-600 transition">üè∑Ô∏è Produtos</button>
            <button id="btn-logistica" onclick="mostrarAba('aba-logistica')" class="text-sm md:text-base text-left p-3 rounded hover:bg-gray-600 transition">üöö Painel de Pedidos</button>
        </nav>
		<nav class="flex flex-row md:flex-col p-4 gap-2 overflow-x-auto whitespace-nowrap">
    <button onclick="window.fazerLogout()" class="mt-auto text-sm text-left p-3 text-red-400 hover:bg-gray-800 rounded transition font-bold">
        üö™ Encerrar Sess√£o
    </button>
</nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 md:p-8">
        
        <div id="aba-cadastro" class="space-y-6">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800" id="titulo-aba-pedido">Novo Pedido <span id="pdf-n-display"></span></h2>
                <input type="hidden" id="pedido-id-atual" value="">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Dados do Cliente & Frete</h3>
                    <div class="space-y-3">
                        <input type="text" id="input-cliente" list="lista-sugestao-clientes" placeholder="Busque o nome do cliente..." class="w-full p-2 border rounded bg-gray-50 border-blue-300 focus:ring-2 focus:ring-blue-500" onchange="window.preencherCliente()">
                        <input type="text" id="input-endereco" placeholder="Endere√ßo Completo (Preenche autom√°tico)" class="w-full p-2 border rounded bg-gray-50">
                        <div class="p-3 bg-blue-50 border border-blue-100 rounded">
                            <p class="text-xs font-semibold text-blue-800 mb-2">C√°lculo de Frete (Frota Pr√≥pria)</p>
                            <div class="flex flex-col md:flex-row gap-2 items-center">
                                <input type="number" id="input-km" placeholder="Dist√¢ncia (KM)" class="w-full md:w-1/3 p-2 border rounded text-sm" onchange="calcularTudo()" onkeyup="calcularTudo()">
                                <input type="number" id="input-litro" value="4.20" step="0.01" class="w-full md:w-1/4 p-2 border rounded text-sm bg-gray-100" readonly>
                                <input type="number" id="input-consumo" value="9.0" class="w-full md:w-1/4 p-2 border rounded text-sm bg-gray-100" readonly>
                                <input type="text" id="display-frete-estimado" placeholder="R$ 0,00" class="w-full md:w-1/3 p-2 border rounded font-bold text-blue-900 bg-transparent text-right" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Controle do Pedido</h3>
                    <div class="space-y-3">
                        <select id="select-status" class="w-full p-2 border rounded bg-gray-50 text-sm">
                            <option value="Or√ßamento">Status: Or√ßamento</option>
                            <option value="Produ√ß√£o">Status: Produ√ß√£o</option>
                            <option value="Em Entrega">Status: Em Entrega</option>
                            <option value="Entregue">Status: Entregue</option>
                        </select>
                        <div class="flex flex-col md:flex-row gap-2">
                            <div class="w-full md:w-1/2">
                                <label class="text-xs text-gray-500">Previs√£o de Entrega</label>
                                <input type="date" id="input-previsao" class="w-full p-2 border rounded bg-gray-50">
                            </div>
                            <div class="w-full md:w-1/2">
                                <label class="text-xs text-gray-500">Status Financeiro</label>
                                <select id="select-financeiro" class="w-full p-2 border rounded bg-gray-50">
                                    <option value="A Receber">A Receber</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Itens do Pedido</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-sm">
                                <th class="p-2 border">Qtd</th><th class="p-2 border">Produto</th><th class="p-2 border">Fornecedor</th><th class="p-2 border w-28">V. Unit. (R$)</th><th class="p-2 border w-28">Total</th><th class="p-2 border w-10 text-center">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-itens">
                            <tr class="text-sm">
                                <td class="p-2 border"><input type="number" value="1" min="1" class="w-16 p-1 border rounded qtd-item" onchange="calcularTudo()" onkeyup="calcularTudo()"></td>
                                <td class="p-2 border"><input type="text" list="lista-sugestao-produtos" placeholder="Nome do produto (Busque aqui)" class="w-full p-1 border rounded desc-item border-blue-300 focus:ring-2 focus:ring-blue-500" onchange="window.preencherProduto(this)"></td>
                                <td class="p-2 border"><input type="text" placeholder="Fornecedor" class="w-full p-1 border rounded forn-item"></td>
                                <td class="p-2 border"><input type="number" value="0.00" step="0.01" class="w-24 p-1 border rounded valor-item" onchange="calcularTudo()" onkeyup="calcularTudo()"></td>
                                <td class="p-2 border font-semibold total-linha">R$ 0,00</td>
                                <td class="p-2 border text-center"><button onclick="this.closest('tr').remove(); calcularTudo();" class="text-red-500 font-bold hover:text-red-700">X</button></td>
                            </tr>
                            <tr class="text-sm" id="linha-adicionar">
                                <td class="p-2 border bg-gray-50 text-center" colspan="6"><button onclick="adicionarLinha()" class="text-blue-600 font-semibold hover:underline w-full py-2">+ Adicionar Novo Item</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start gap-6">
                <div class="w-full md:w-1/2 space-y-4 md:pr-4">
                    <h3 class="text-lg font-semibold text-gray-700">Pagamento & Desconto</h3>
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-xs text-gray-500">Desconto Geral (%)</label><input type="number" id="input-desconto" value="0" min="0" class="w-full p-2 border rounded bg-gray-50" onchange="calcularTudo()" onkeyup="calcularTudo()"></div>
                        <div class="w-1/2"><label class="text-xs text-gray-500">Forma de Pagamento</label><select id="select-pagamento" class="w-full p-2 border rounded bg-gray-50" onchange="calcularTudo()"><option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option></select></div>
                    </div>
                    <div id="info-taxa" class="hidden text-sm text-red-600 bg-red-50 p-2 rounded border border-red-100"></div>
                </div>
                <div class="w-full md:w-1/3 bg-gray-50 p-4 rounded border text-right">
                    <p class="text-gray-500" id="display-subtotal">Subtotal: R$ 0,00</p>
                    <p class="text-green-600 font-medium" id="display-desconto">Desconto: - R$ 0,00</p>
                    <p class="text-gray-500" id="display-frete-final">Frete: R$ 0,00</p>
                    <p class="text-red-500 hidden" id="display-taxa-final">Acr√©scimo Cart√£o: R$ 0,00</p>
                    <div class="border-t mt-2 pt-2 mb-4"><p class="text-2xl font-bold text-gray-800" id="display-total">Total: R$ 0,00</p></div>
                    
                    <div class="flex flex-col gap-2">
                        <button id="btn-cancelar-pedido" class="hidden w-full bg-gray-500 text-white font-bold py-2 rounded hover:bg-gray-600 transition" onclick="window.limparTelaPedido()">‚ùå Cancelar Edi√ß√£o</button>
                        <button id="btn-salvar" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition">üíæ Salvar Novo Pedido</button>
                        <button id="btn-gerar-pdf" onclick="gerarPDF()" data-total="0,00" class="w-full bg-gray-800 text-white font-bold py-2 rounded hover:bg-gray-900 border border-gray-700 shadow-sm">üñ®Ô∏è Imprimir / PDF A4</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="aba-clientes" class="hidden space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 border-b pb-2">Gest√£o de Clientes</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold mb-4 text-gray-700" id="titulo-form-cliente">Novo Cliente</h3>
                <div class="space-y-4 max-w-2xl">
                    <input type="hidden" id="cli-id" value="">
                    <div><label class="text-sm text-gray-600">Nome Completo</label><input type="text" id="cli-nome" class="w-full p-2 border rounded bg-gray-50"></div>
                    <div><label class="text-sm text-gray-600">Endere√ßo Completo</label><input type="text" id="cli-endereco" class="w-full p-2 border rounded bg-gray-50"></div>
                    <div class="pt-4 flex gap-2 justify-end">
                        <button id="btn-salvar-cliente" class="bg-blue-600 text-white font-bold py-2 px-6 rounded hover:bg-blue-700 transition">üíæ Salvar Cliente</button>
                    </div>
                </div>
                <div class="mt-8 border-t pt-6">
                    <table class="w-full text-left border-collapse"><tbody id="lista-clientes" class="text-sm"><tr><td colspan="3" class="p-4 text-center">Carregando...</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <div id="aba-produtos" class="hidden space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 border-b pb-2">Gest√£o de Produtos</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold mb-4 text-gray-700" id="titulo-form-produto">Novo Produto</h3>
                <div class="space-y-4 max-w-2xl">
                    <input type="hidden" id="prod-id" value="">
                    <div><label class="text-sm text-gray-600">Descri√ß√£o</label><input type="text" id="prod-desc" class="w-full p-2 border rounded bg-gray-50"></div>
                    <div><label class="text-sm text-gray-600">Valor Base</label><input type="number" id="prod-valor" class="w-full p-2 border rounded bg-gray-50"></div>
                    <div class="pt-4 flex gap-2 justify-end">
                        <button id="btn-salvar-produto" class="bg-blue-600 text-white font-bold py-2 px-6 rounded hover:bg-blue-700 transition">üíæ Salvar Produto</button>
                    </div>
                </div>
                <div class="mt-8 border-t pt-6">
                    <table class="w-full text-left border-collapse"><tbody id="lista-produtos" class="text-sm"><tr><td colspan="3" class="p-4 text-center">Carregando...</td></tr></tbody></table>
                </div>
            </div>
        </div>

        <div id="aba-logistica" class="hidden space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 border-b pb-2">Painel de Pedidos</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <input type="text" placeholder="üîç Buscar cliente..." class="p-2 border rounded mb-4 w-full" onkeyup="window.filtrarPedidos(this.value)">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse"><tbody id="tabela-pedidos"></tbody></table>
                </div>
            </div>
        </div>
    </main>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, doc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBb8UGRV8qcjV6-_kd7WucWhoJBKSHcUac",
            authDomain: "mpleaoerp.firebaseapp.com",
            projectId: "mpleaoerp",
            storageBucket: "mpleaoerp.firebasestorage.app",
            messagingSenderId: "806362757682",
            appId: "1:806362757682:web:3cefbea0483af0ef251a2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- SEGURAN√áA: TRAVA DE LOGIN ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                carregarMemoriaBanco();
            }
        });

        window.fazerLogout = function() {
            signOut(auth).then(() => { window.location.href = "login.html"; });
        }

        window.bancoClientes = []; window.bancoProdutos = []; window.bancoPedidos = [];

        // --- N√öMERO SEQUENCIAL ---
        async function obterProximoNumeroPedido() {
            const ref = doc(db, "configuracoes", "contador_pedidos");
            return await runTransaction(db, async (t) => {
                const snap = await t.get(ref);
                const n = snap.exists() ? snap.data().ultimo_numero + 1 : 1;
                t.set(ref, { ultimo_numero: n }); return n;
            });
        }

        async function carregarMemoriaBanco() {
            try {
                const cliSnap = await getDocs(collection(db, "clientes"));
                window.bancoClientes = cliSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const prodSnap = await getDocs(collection(db, "produtos"));
                window.bancoProdutos = prodSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const pedSnap = await getDocs(collection(db, "pedidos"));
                window.bancoPedidos = pedSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.bancoPedidos.sort((a,b) => (b.data_criacao?.seconds || 0) - (a.data_criacao?.seconds || 0));
                renderizarTudo();
            } catch (e) { console.error(e); }
        }

        function renderizarTudo() {
            document.getElementById('tabela-pedidos').innerHTML = window.bancoPedidos.map(p => `
                <tr class="border-b text-sm">
                    <td class="p-2 border-r font-bold">#${p.numero_sequencial?.toString().padStart(3,'0') || 'S/N'}</td>
                    <td class="p-2 border-r">${p.data_criacao ? new Date(p.data_criacao.seconds*1000).toLocaleDateString() : '-'}</td>
                    <td class="p-2 border-r">${p.cliente_nome}</td>
                    <td class="p-2 border-r">${p.status}</td>
                    <td class="p-2 border-r">R$ ${p.valor_total}</td>
                    <td class="p-2 text-center"><button onclick="window.abrirPedidoParaEdicao('${p.id}')" class="bg-gray-800 text-yellow-500 px-2 py-1 rounded">üëÅÔ∏è Abrir</button></td>
                </tr>`).join('');

            document.getElementById('lista-clientes').innerHTML = window.bancoClientes.map(c => `
                <tr class="border-b text-sm"><td class="p-2">${c.nome}</td><td class="p-2">${c.endereco}</td><td class="p-2"><button onclick="window.editarCliente('${c.id}','${c.nome}','','','${c.endereco}')">‚úèÔ∏è</button><button onclick="window.excluirCliente('${c.id}')" class="ml-2 text-red-600">üóëÔ∏è</button></td></tr>`).join('');

            document.getElementById('lista-produtos').innerHTML = window.bancoProdutos.map(p => `
                <tr class="border-b text-sm"><td class="p-2">${p.descricao}</td><td class="p-2">R$ ${p.valor_base}</td><td class="p-2"><button onclick="window.editarProduto('${p.id}','${p.descricao}','','${p.valor_base}')">‚úèÔ∏è</button><button onclick="window.excluirProduto('${p.id}')" class="ml-2 text-red-600">üóëÔ∏è</button></td></tr>`).join('');

            document.getElementById('lista-sugestao-clientes').innerHTML = window.bancoClientes.map(c => `<option value="${c.nome}">`).join('');
            document.getElementById('lista-sugestao-produtos').innerHTML = window.bancoProdutos.map(p => `<option value="${p.descricao}">`).join('');
        }

        // --- SALVAR PEDIDO ---
        document.getElementById('btn-salvar').addEventListener('click', async () => {
            const btn = document.getElementById('btn-salvar'); const id = document.getElementById('pedido-id-atual').value;
            btn.innerHTML = '...';
            const dados = {
                cliente_nome: document.getElementById('input-cliente').value,
                cliente_endereco: document.getElementById('input-endereco').value,
                status: document.getElementById('select-status').value,
                valor_total: parseFloat(document.getElementById('btn-gerar-pdf').getAttribute('data-total').replace(',','.')),
                itens: []
            };
            document.querySelectorAll('#tabela-itens tr:not(#linha-adicionar)').forEach(tr => {
                const desc = tr.querySelector('.desc-item').value;
                if(desc) dados.itens.push({ quantidade: tr.querySelector('.qtd-item').value, descricao: desc, fornecedor: tr.querySelector('.forn-item').value, valor_unitario: tr.querySelector('.valor-item').value });
            });
            if(id) await updateDoc(doc(db,"pedidos",id), dados);
            else { dados.numero_sequencial = await obterProximoNumeroPedido(); dados.data_criacao = serverTimestamp(); await addDoc(collection(db,"pedidos"), dados); }
            window.location.reload();
        });

        // --- SALVAR SEM RELOAD ---
        document.getElementById('btn-salvar-cliente').addEventListener('click', async () => {
            const id = document.getElementById('cli-id').value;
            const d = { nome: document.getElementById('cli-nome').value, endereco: document.getElementById('cli-endereco').value };
            if(id) await updateDoc(doc(db,"clientes",id), d); else await addDoc(collection(db,"clientes"), {...d, data_cadastro: serverTimestamp()});
            document.getElementById('cli-id').value = ''; document.getElementById('cli-nome').value = ''; document.getElementById('cli-endereco').value = '';
            alert("Cliente Salvo!"); carregarMemoriaBanco();
        });

        document.getElementById('btn-salvar-produto').addEventListener('click', async () => {
            const id = document.getElementById('prod-id').value;
            const d = { descricao: document.getElementById('prod-desc').value, valor_base: document.getElementById('prod-valor').value };
            if(id) await updateDoc(doc(db,"produtos",id), d); else await addDoc(collection(db,"produtos"), {...d, data_cadastro: serverTimestamp()});
            document.getElementById('prod-id').value = ''; document.getElementById('prod-desc').value = ''; document.getElementById('prod-valor').value = '';
            alert("Produto Salvo!"); carregarMemoriaBanco();
        });

        // --- ABRIR COM TRAVA DE STATUS ---
        window.abrirPedidoParaEdicao = function(id) {
            const p = window.bancoPedidos.find(p => p.id === id);
            if(!p) return;

            document.getElementById('pedido-id-atual').value = id;
            document.getElementById('input-cliente').value = p.cliente_nome;
            document.getElementById('input-endereco').value = p.cliente_endereco;
            document.getElementById('select-status').value = p.status;
            document.getElementById('pdf-n-display').innerText = '#' + (p.numero_sequencial?.toString().padStart(3,'0') || '???');
            
            const tbody = document.getElementById('tabela-itens');
            tbody.innerHTML = '<tr id="linha-adicionar"><td colspan="6" class="p-2 text-center"><button id="btn-add-item-tabela" onclick="adicionarLinha()" class="text-blue-600 font-bold">+ Adicionar Item</button></td></tr>';
            
            p.itens.forEach(i => {
                const tr = document.createElement('tr'); tr.className = 'text-sm';
                tr.innerHTML = `<td class="p-2 border"><input type="number" value="${i.quantidade}" class="w-16 p-1 border rounded qtd-item" onchange="calcularTudo()"></td><td class="p-2 border"><input type="text" list="lista-sugestao-produtos" value="${i.descricao}" class="w-full p-1 border rounded desc-item" onchange="window.preencherProduto(this)"></td><td class="p-2 border"><input type="text" value="${i.fornecedor || ''}" class="w-full p-1 border rounded forn-item"></td><td class="p-2 border"><input type="number" value="${i.valor_unitario}" class="w-full p-1 border rounded valor-item" onchange="calcularTudo()"></td><td class="p-2 border total-linha">R$ 0,00</td><td class="p-2 border text-center"><button onclick="this.closest('tr').remove(); calcularTudo();" class="text-red-500 font-bold">X</button></td>`;
                tbody.insertBefore(tr, document.getElementById('linha-adicionar'));
            });

            // L√ìGICA DE TRAVA E AVISOS
            const inputs = document.querySelectorAll('#aba-cadastro input, #aba-cadastro select');
            const btnS = document.getElementById('btn-salvar');
            const tit = document.getElementById('titulo-aba-pedido');

            if (p.status === 'Entregue' || p.status === 'Em Entrega') {
                inputs.forEach(el => { if(el.id !== 'select-status') el.disabled = true; });
                btnS.classList.add('hidden');
                tit.innerHTML = `‚ö†Ô∏è #${p.numero_sequencial} - ${p.status.toUpperCase()} (BLOQUEADO)`;
                tit.classList.add('text-red-600');
                alert("Aten√ß√£o: Este pedido j√° saiu ou foi entregue. Edi√ß√£o bloqueada por seguran√ßa.");
            } else if (p.status === 'Produ√ß√£o') {
                inputs.forEach(el => el.disabled = false);
                btnS.classList.remove('hidden');
                tit.innerHTML = `üõ†Ô∏è EM PRODU√á√ÉO (CUIDADO AO EDITAR)`;
                tit.classList.add('text-orange-500');
            } else {
                inputs.forEach(el => el.disabled = false);
                btnS.classList.remove('hidden');
                tit.innerText = 'Editar Or√ßamento';
                tit.classList.remove('text-red-600', 'text-orange-500');
            }
            mostrarAba('aba-cadastro'); calcularTudo();
        };

        window.editarCliente = (id,n,t,d,e) => { document.getElementById('cli-id').value=id; document.getElementById('cli-nome').value=n; document.getElementById('cli-endereco').value=e; mostrarAba('aba-clientes'); };
        window.editarProduto = (id,d,f,v) => { document.getElementById('prod-id').value=id; document.getElementById('prod-desc').value=d; document.getElementById('prod-valor').value=v; mostrarAba('aba-produtos'); };
        window.excluirCliente = async (id) => { if(confirm("Excluir?")){ await deleteDoc(doc(db,"clientes",id)); carregarMemoriaBanco(); } };
        window.excluirProduto = async (id) => { if(confirm("Excluir?")){ await deleteDoc(doc(db,"produtos",id)); carregarMemoriaBanco(); } };
        window.preencherCliente = () => { const c = window.bancoClientes.find(x => x.nome === document.getElementById('input-cliente').value); if(c) document.getElementById('input-endereco').value = c.endereco; };
        window.preencherProduto = (el) => { const p = window.bancoProdutos.find(x => x.descricao === el.value); if(p){ const tr = el.closest('tr'); tr.querySelector('.valor-item').value = p.valor_base; calcularTudo(); } };
        window.filtrarPedidos = (t) => { const f = window.bancoPedidos.filter(p => p.cliente_nome.toLowerCase().includes(t.toLowerCase())); renderizarTabelaPedidosNoFilter(f); };
        
        function renderizarTabelaPedidosNoFilter(lista) {
            document.getElementById('tabela-pedidos').innerHTML = lista.map(p => `
                <tr class="border-b text-sm">
                    <td class="p-2 border-r font-bold">#${p.numero_sequencial?.toString().padStart(3,'0') || 'S/N'}</td>
                    <td class="p-2 border-r">${p.data_criacao ? new Date(p.data_criacao.seconds*1000).toLocaleDateString() : '-'}</td>
                    <td class="p-2 border-r">${p.cliente_nome}</td>
                    <td class="p-2 border-r">${p.status}</td>
                    <td class="p-2 border-r">R$ ${p.valor_total}</td>
                    <td class="p-2 text-center"><button onclick="window.abrirPedidoParaEdicao('${p.id}')" class="bg-gray-800 text-yellow-500 px-2 py-1 rounded">üëÅÔ∏è Abrir</button></td>
                </tr>`).join('');
        }
    </script>
</body>
</html>